{"version":3,"file":"shared-timer-worker.js","sources":["../src/shared-timer-worker.js"],"sourcesContent":["const tasks = new Map();\nconst ports = new Set();\n\nself.onconnect = (e) => {\n  const port = e.ports[0];\n  ports.add(port);\n\n  port.onmessage = (event) => {\n    const { action, taskName, intervalTime, canRepeat } = event.data;\n\n    switch (action) {\n      case 'ADD_TASK':\n        addTask(taskName, intervalTime, canRepeat);\n        break;\n      case 'CLEAR_TASK':\n        clearTask(taskName);\n        break;\n      case 'REMOVE_ALL':\n        removeAllTasks();\n        break;\n      case 'PING':\n        port.postMessage({ action: 'PONG', taskName });\n        break;\n    }\n  };\n\n  port.start();\n};\n\nfunction addTask(taskName, intervalTime, canRepeat) {\n  // Clear existing task if it exists\n  if (tasks.has(taskName)) {\n    clearInterval(tasks.get(taskName).timerId);\n  }\n\n  const timerId = setInterval(() => {\n    // Notify all connected ports\n    ports.forEach(port => {\n      port.postMessage({\n        action: 'TIMER_TICK',\n        taskName,\n        timestamp: Date.now()\n      });\n    });\n\n    // If not repeating, clear after first execution\n    if (!canRepeat) {\n      clearTask(taskName);\n    }\n  }, intervalTime);\n\n  tasks.set(taskName, { timerId, intervalTime, canRepeat });\n}\n\nfunction clearTask(taskName) {\n  const task = tasks.get(taskName);\n  if (task) {\n    clearInterval(task.timerId);\n    tasks.delete(taskName);\n    \n    // Notify all ports that task was cleared\n    ports.forEach(port => {\n      port.postMessage({\n        action: 'TASK_CLEARED',\n        taskName\n      });\n    });\n  }\n}\n\nfunction removeAllTasks() {\n  tasks.forEach((task, taskName) => {\n    clearInterval(task.timerId);\n  });\n  tasks.clear();\n  \n  // Notify all ports\n  ports.forEach(port => {\n    port.postMessage({\n      action: 'ALL_TASKS_CLEARED'\n    });\n  });\n}\n\n// ============================================\n// timer-manager.js\n// This is the main package file\n\nclass TimerManager {\n  constructor(workerPath = '/shared-timer-worker.js') {\n    this.worker = null;\n    this.workerPath = workerPath;\n    this.callbacks = new Map();\n    this.isConnected = false;\n    this.init();\n  }\n\n  init() {\n    try {\n      this.worker = new SharedWorker(this.workerPath);\n      this.worker.port.start();\n      \n      this.worker.port.onmessage = (event) => {\n        this.handleWorkerMessage(event.data);\n      };\n\n      this.worker.onerror = (error) => {\n        console.error('SharedWorker error:', error);\n      };\n\n      this.isConnected = true;\n    } catch (error) {\n      console.error('Failed to initialize SharedWorker:', error);\n      throw new Error('SharedWorker not supported or failed to initialize');\n    }\n  }\n\n  handleWorkerMessage(data) {\n    const { action, taskName, timestamp } = data;\n\n    switch (action) {\n      case 'TIMER_TICK':\n        const callback = this.callbacks.get(taskName);\n        if (callback) {\n          callback(taskName, timestamp);\n        }\n        break;\n      case 'TASK_CLEARED':\n        // Optionally handle task cleared event\n        break;\n      case 'ALL_TASKS_CLEARED':\n        this.callbacks.clear();\n        break;\n      case 'PONG':\n        // Health check response\n        break;\n    }\n  }\n\n  /**\n   * Add a timer task\n   * @param {string} taskName - Unique name for the task\n   * @param {number} intervalTime - Interval in milliseconds\n   * @param {Function} callback - Function to call on each interval\n   * @param {boolean} canRepeat - Whether the task should repeat\n   */\n  addTimerTask(taskName, intervalTime, callback, canRepeat = true) {\n    if (!this.isConnected) {\n      throw new Error('TimerManager is not connected to SharedWorker');\n    }\n\n    if (typeof callback !== 'function') {\n      throw new Error('Callback must be a function');\n    }\n\n    // Store the callback\n    this.callbacks.set(taskName, callback);\n\n    // Send message to worker\n    this.worker.port.postMessage({\n      action: 'ADD_TASK',\n      taskName,\n      intervalTime,\n      canRepeat\n    });\n  }\n\n  /**\n   * Clear a specific timer task\n   * @param {string} taskName - Name of the task to clear\n   */\n  clearTimerTask(taskName) {\n    if (!this.isConnected) {\n      throw new Error('TimerManager is not connected to SharedWorker');\n    }\n\n    this.callbacks.delete(taskName);\n    this.worker.port.postMessage({\n      action: 'CLEAR_TASK',\n      taskName\n    });\n  }\n\n  /**\n   * Remove all timer tasks\n   */\n  removeAllTimerTasks() {\n    if (!this.isConnected) {\n      throw new Error('TimerManager is not connected to SharedWorker');\n    }\n\n    this.callbacks.clear();\n    this.worker.port.postMessage({\n      action: 'REMOVE_ALL'\n    });\n  }\n\n  /**\n   * Check if worker is connected\n   */\n  ping(taskName = 'health-check') {\n    if (!this.isConnected) {\n      return false;\n    }\n\n    this.worker.port.postMessage({\n      action: 'PING',\n      taskName\n    });\n    return true;\n  }\n}\n\n// Export for ES modules\nexport default TimerManager;\n\n// Also support CommonJS\nif (typeof module !== 'undefined' && module.exports) {\n  module.exports = TimerManager;\n}"],"names":[],"mappings":"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"}